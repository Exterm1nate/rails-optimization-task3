# Оптимизация импорта

## Шаг 1

Изначальное время импорта для `small.json` -- 7.5 секунд.

Снача отрефакторим. 

Ruby-prof в отчете показывает какую-то ерунду, а Valgrind не хочет работать с командой rake.

Потому ориентироваться будем в основном на PgHero и оптимизировать запросы к БД.
Видно, что много запросов выполняется для поиска уже созданных записей, потому первый шаг оптимизации заключается
в уменьшении количества запросов к БД путем сохранения уже созданных записей (а вернее - их id) в хэши.

По итогу избавились от большей части ненужных поисковых запросов, но некоторые все равно остались.

После оптимизации для `small.json` -- 3.9 секунд.

## Шаг 2

Изначально для `medium.json` -- 27.5 секунд.

Для поиска мест вызовов ненужных запросов включим логгирование.
По нему становится понятно, что все лишние запросы выполняются во время создания Trip. 
Для решения данной проблемы, а также проблемы создания записей по одной, воспользуемся гемом `activerecord-import`.
Для простоты алгоритма сначала реализуем импорт только для Trip.

После оптимизации для `medium.json` -- 5.4 секунд, для `large.json` -- 19 секунд. Цель достигнута.

# Оптимизация TripsController#index

## Шаг 1

Изначально для 1003 рейсов -- 21 секунда.

`bullet` показывает, что присутствует проблема `N + 1` (на `bus`). 
PgHero также фиксирует 648 запросов к таблице `buses` и 648 к `services`.

```sql
SELECT  "buses".* FROM "buses" WHERE "buses"."id" = $1 LIMIT $2
```

```sql
SELECT "services".* FROM "services" INNER JOIN "buses_services" ON "services"."id" = "buses_services"."service_id" WHERE "buses_services"."bus_id" = $1
```

После оптимизации -- 12.8 секунд

## Шаг 2

